<html>
<script src="./dagre-d3.js"></script>
<script src="https://d3js.org/d3.v3.min.js"></script>
<style>

body {
  font: 300 14px 'Helvetica Neue', Helvetica;
}

.node rect {
  stroke: #333;
  fill: #fff;
}

.edgePath path {
  stroke: #333;
  fill: #333;
  stroke-width: 1.5px;
}
</style>
<body>
<svg width="2000" height="1500">
  <g></g>
</svg>
<script>
  
// Create a new directed graph

var nodes = [
	{"id":"0","label":"<0>:   %retval = alloca i32, align 4"},
	{"id":"1","label":"<1>:   store i32 %call, i32* %dump_code, align 4"},
	{"id":"2","label":"<2>:   store i32 %call2, i32* %ni, align 4"},
	{"id":"3","label":"<3>:   store i32 %call4, i32* %nj, align 4"},
	{"id":"4","label":"<4>:   store i32 %call6, i32* %nk, align 4"},
	{"id":"5","label":"<5>:   store i32 %call8, i32* %nl, align 4"},
	{"id":"6","label":"<6>:   %20 = bitcast i8* %call10 to double*"},
	{"id":"7","label":"<7>:   %31 = bitcast i8* %call15 to double*"},
	{"id":"8","label":"<8>:   %42 = bitcast i8* %call20 to double*"},
	{"id":"9","label":"<9>:   %53 = bitcast i8* %call25 to double*"},
	{"id":"10","label":"<10>:   %64 = bitcast i8* %call30 to double*"},
	{"id":"11","label":"<11>:   %73 = load i32, i32* %ni, align 4"},
	{"id":"12","label":"<12>:   %84 = load i32, i32* %dump_code, align 4"},
	{"id":"13","label":"<13>:   %85 = load i32, i32* %ni, align 4"},
	{"id":"14","label":"<14>:   br label %if.end"},
	{"id":"15","label":"<15>:   %88 = load double*, double** %tmp, align 8"},
	{"id":"16","label":"<16>:   %90 = load double*, double** %A, align 8"},
	{"id":"17","label":"<17>:   %92 = load double*, double** %B, align 8"},
	{"id":"18","label":"<18>:   %94 = load double*, double** %C, align 8"},
	{"id":"19","label":"<19>:   %96 = load double*, double** %D, align 8"},
	{"id":"20","label":"<20>:   ret i32 0"},
	{"id":"21","label":"<21>:   %ni.addr = alloca i32, align 4"},
	{"id":"22","label":"<22>:   %18 = load i32, i32* %i, align 4"},
	{"id":"23","label":"<23>:   store i32 0, i32* %j, align 4"},
	{"id":"24","label":"<24>:   %20 = load i32, i32* %j, align 4"},
	{"id":"25","label":"<25>:   %22 = load i32, i32* %i, align 4"},
	{"id":"26","label":"<26>:   %29 = load i32, i32* %j, align 4"},
	{"id":"27","label":"<27>:   br label %for.inc8"},
	{"id":"28","label":"<28>:   %30 = load i32, i32* %i, align 4"},
	{"id":"29","label":"<29>:   store i32 0, i32* %i, align 4"},
	{"id":"30","label":"<30>:   %31 = load i32, i32* %i, align 4"},
	{"id":"31","label":"<31>:   store i32 0, i32* %j, align 4"},
	{"id":"32","label":"<32>:   %33 = load i32, i32* %j, align 4"},
	{"id":"33","label":"<33>:   %35 = load i32, i32* %i, align 4"},
	{"id":"34","label":"<34>:   %42 = load i32, i32* %j, align 4"},
	{"id":"35","label":"<35>:   br label %for.inc31"},
	{"id":"36","label":"<36>:   %43 = load i32, i32* %i, align 4"},
	{"id":"37","label":"<37>:   store i32 0, i32* %i, align 4"},
	{"id":"38","label":"<38>:   %44 = load i32, i32* %i, align 4"},
	{"id":"39","label":"<39>:   store i32 0, i32* %j, align 4"},
	{"id":"40","label":"<40>:   %46 = load i32, i32* %j, align 4"},
	{"id":"41","label":"<41>:   %48 = load i32, i32* %i, align 4"},
	{"id":"42","label":"<42>:   %55 = load i32, i32* %j, align 4"},
	{"id":"43","label":"<43>:   br label %for.inc55"},
	{"id":"44","label":"<44>:   %56 = load i32, i32* %i, align 4"},
	{"id":"45","label":"<45>:   store i32 0, i32* %i, align 4"},
	{"id":"46","label":"<46>:   %57 = load i32, i32* %i, align 4"},
	{"id":"47","label":"<47>:   store i32 0, i32* %j, align 4"},
	{"id":"48","label":"<48>:   %59 = load i32, i32* %j, align 4"},
	{"id":"49","label":"<49>:   %61 = load i32, i32* %i, align 4"},
	{"id":"50","label":"<50>:   %68 = load i32, i32* %j, align 4"},
	{"id":"51","label":"<51>:   br label %for.inc79"},
	{"id":"52","label":"<52>:   %69 = load i32, i32* %i, align 4"},
	{"id":"53","label":"<53>:   ret void"},
	{"id":"54","label":"<54>:   %ni.addr = alloca i32, align 4"},
	{"id":"55","label":"<55>:   %20 = load i32, i32* %i, align 4"},
	{"id":"56","label":"<56>:   store i32 0, i32* %j, align 4"},
	{"id":"57","label":"<57>:   %22 = load i32, i32* %j, align 4"},
	{"id":"58","label":"<58>:   %24 = load double*, double** %tmp.addr, align 8"},
	{"id":"59","label":"<59>:   %28 = load i32, i32* %k, align 4"},
	{"id":"60","label":"<60>:   %30 = load double, double* %alpha.addr, align 8"},
	{"id":"61","label":"<61>:   %46 = load i32, i32* %k, align 4"},
	{"id":"62","label":"<62>:   br label %for.inc25"},
	{"id":"63","label":"<63>:   %47 = load i32, i32* %j, align 4"},
	{"id":"64","label":"<64>:   br label %for.inc28"},
	{"id":"65","label":"<65>:   %48 = load i32, i32* %i, align 4"},
	{"id":"66","label":"<66>:   store i32 0, i32* %i, align 4"},
	{"id":"67","label":"<67>:   %49 = load i32, i32* %i, align 4"},
	{"id":"68","label":"<68>:   store i32 0, i32* %j, align 4"},
	{"id":"69","label":"<69>:   %51 = load i32, i32* %j, align 4"},
	{"id":"70","label":"<70>:   %53 = load double, double* %beta.addr, align 8"},
	{"id":"71","label":"<71>:   %59 = load i32, i32* %k, align 4"},
	{"id":"72","label":"<72>:   %61 = load double*, double** %tmp.addr, align 8"},
	{"id":"73","label":"<73>:   %76 = load i32, i32* %k, align 4"},
	{"id":"74","label":"<74>:   br label %for.inc62"},
	{"id":"75","label":"<75>:   %77 = load i32, i32* %j, align 4"},
	{"id":"76","label":"<76>:   br label %for.inc65"},
	{"id":"77","label":"<77>:   %78 = load i32, i32* %i, align 4"},
	{"id":"78","label":"<78>:   ret void"},
	{"id":"79","label":"<79>:   %ni.addr = alloca i32, align 4"},
	{"id":"80","label":"<80>:   %4 = load i32, i32* %i, align 4"},
	{"id":"81","label":"<81>:   store i32 0, i32* %j, align 4"},
	{"id":"82","label":"<82>:   %6 = load i32, i32* %j, align 4"},
	{"id":"83","label":"<83>:   %8 = load %struct._IO_FILE*, %struct._IO_FILE** @stderr, align 8"},
	{"id":"84","label":"<84>:   %14 = load i32, i32* %i, align 4"},
	{"id":"85","label":"<85>:   %17 = load %struct._IO_FILE*, %struct._IO_FILE** @stderr, align 8"},
	{"id":"86","label":"<86>:   br label %if.end"},
	{"id":"87","label":"<87>:   br label %for.inc"},
	{"id":"88","label":"<88>:   %18 = load i32, i32* %j, align 4"},
	{"id":"89","label":"<89>:   br label %for.inc8"},
	{"id":"90","label":"<90>:   %19 = load i32, i32* %i, align 4"},
	{"id":"91","label":"<91>:   %20 = load %struct._IO_FILE*, %struct._IO_FILE** @stderr, align 8"},
	{"id":"92","label":"<92>:   ret void"}];

var links = [
	["0","1",{"label":""}],
	["1","2",{"label":""}],
	["2","3",{"label":""}],
	["3","4",{"label":""}],
	["4","5",{"label":""}],
	["5","6",{"label":""}],
	["6","7",{"label":""}],
	["7","8",{"label":""}],
	["8","9",{"label":""}],
	["9","10",{"label":""}],
	["10","21",{"label":""}],
	["53","11",{"label":""}],
	["11","54",{"label":""}],
	["78","12",{"label":""}],
	["12","13",{"label":""}],
	["12","15",{"label":""}],
	["13","79",{"label":""}],
	["92","14",{"label":""}],
	["14","15",{"label":""}],
	["15","16",{"label":""}],
	["16","17",{"label":""}],
	["17","18",{"label":""}],
	["18","19",{"label":""}],
	["19","20",{"label":""}],
	["21","22",{"label":""}],
	["22","23",{"label":""}],
	["22","29",{"label":""}],
	["23","24",{"label":""}],
	["24","25",{"label":""}],
	["24","27",{"label":""}],
	["25","26",{"label":""}],
	["26","24",{"label":""}],
	["27","28",{"label":""}],
	["28","22",{"label":""}],
	["29","30",{"label":""}],
	["30","31",{"label":""}],
	["30","37",{"label":""}],
	["31","32",{"label":""}],
	["32","33",{"label":""}],
	["32","35",{"label":""}],
	["33","34",{"label":""}],
	["34","32",{"label":""}],
	["35","36",{"label":""}],
	["36","30",{"label":""}],
	["37","38",{"label":""}],
	["38","39",{"label":""}],
	["38","45",{"label":""}],
	["39","40",{"label":""}],
	["40","41",{"label":""}],
	["40","43",{"label":""}],
	["41","42",{"label":""}],
	["42","40",{"label":""}],
	["43","44",{"label":""}],
	["44","38",{"label":""}],
	["45","46",{"label":""}],
	["46","47",{"label":""}],
	["46","53",{"label":""}],
	["47","48",{"label":""}],
	["48","49",{"label":""}],
	["48","51",{"label":""}],
	["49","50",{"label":""}],
	["50","48",{"label":""}],
	["51","52",{"label":""}],
	["52","46",{"label":""}],
	["54","55",{"label":""}],
	["55","56",{"label":""}],
	["55","66",{"label":""}],
	["56","57",{"label":""}],
	["57","58",{"label":""}],
	["57","64",{"label":""}],
	["58","59",{"label":""}],
	["59","60",{"label":""}],
	["59","62",{"label":""}],
	["60","61",{"label":""}],
	["61","59",{"label":""}],
	["62","63",{"label":""}],
	["63","57",{"label":""}],
	["64","65",{"label":""}],
	["65","55",{"label":""}],
	["66","67",{"label":""}],
	["67","68",{"label":""}],
	["67","78",{"label":""}],
	["68","69",{"label":""}],
	["69","70",{"label":""}],
	["69","76",{"label":""}],
	["70","71",{"label":""}],
	["71","72",{"label":""}],
	["71","74",{"label":""}],
	["72","73",{"label":""}],
	["73","71",{"label":""}],
	["74","75",{"label":""}],
	["75","69",{"label":""}],
	["76","77",{"label":""}],
	["77","67",{"label":""}],
	["79","80",{"label":""}],
	["80","81",{"label":""}],
	["80","91",{"label":""}],
	["81","82",{"label":""}],
	["82","83",{"label":""}],
	["82","89",{"label":""}],
	["83","84",{"label":""}],
	["84","85",{"label":""}],
	["84","87",{"label":""}],
	["85","86",{"label":""}],
	["86","87",{"label":""}],
	["87","88",{"label":""}],
	["88","82",{"label":""}],
	["89","90",{"label":""}],
	["90","80",{"label":""}],
	["91","92",{"label":""}]];

var SCClist = {"scc0":["24","25","26"], "scc1":["71","72","73"]};
var appliedSCC = [];

// Automatically label each of the nodes
var g = new dagreD3.graphlib.Graph().setGraph({});

var idx = 255;
var svg = d3.select("svg"),
    inner = svg.select("g");

function deleteLinks(node, deletedlinks) {
	g.edges().forEach(function(e) {
		if (e.v==node)
		{
			deletedlinks["out"].push(e);
			g.removeEdge(e.v, e.w);
		}
		else if (e.w==node)
		{
			deletedlinks["in"].push(e);
			g.removeEdge(e.v, e.w);
		}
	});
}

function deleteNode(node) {
	g.nodes().forEach(function(v) {
		if (v == node)
		{
			g.removeNode(node);
		}
	});
}

function makeLinks(node, deletedlinks, sccnodes){
	deletedlinks["in"].forEach(function(e) {
		if (!sccnodes.includes(e.v)){
			var link = [e.v, node, {"label":""}];
			g.setEdge.apply(g, link);
		}
	});
	deletedlinks["out"].forEach(function(e) {
		if (!sccnodes.includes(e.w)) {
			var link = [node, e.w, {"label" : ""}];
			g.setEdge.apply(g, link);
		}
	});
}

function revertGraph() {
	g.edges().forEach(function(e) {
		if (e.v.includes("scc") || e.w.includes("scc"))
		{
			g.removeEdge(e.v,e.w);
		}
	});
	g.nodes().forEach(function(v) {
		if (v.includes("scc"))
		{
			g.removeNode(v);
		}
	});

	nodes.forEach(function(node) {
	  g.setNode(node["id"], { label: node["label"] }); 
	});

	links.forEach((edge)=>{
	 g.setEdge.apply(g, edge);
	});   
}

function isCollapsable(node) {
	for (var key in SCClist) {
		if (SCClist.hasOwnProperty(key)) {
			if (SCClist[key].includes(node))
				return true;
		}
	}
	return false;
}

function getsccID(node) {
	for (var key in SCClist) {
		if (SCClist.hasOwnProperty(key)) {
			if (SCClist[key].includes(node))
				return key;
		}
	}
	return "";
}

function collapseSCC(render) {
	revertGraph();

	appliedSCC.forEach(function(sccID) {
		var deletedlinks = {"in":[], "out":[]};
		var sccnodes = SCClist[sccID];
		sccnodes.forEach(function(element) {
			deleteLinks(element, deletedlinks);
			deleteNode(element);
		});
		var node = {"id":sccID,"label":sccID}
		g.setNode(node["id"], {label: node["label"]});
		makeLinks(sccID, deletedlinks, sccnodes);

	});

	redraw_graph(render);
}

function redraw_graph(render) {

      g.nodes().forEach(function(v) {
        var node = g.node(v);
        // Round the corners of the nodes
        node.rx = node.ry = 5;
      });

      render(inner, g);  
      svg.selectAll("g.node").on("click", function(id){clickNode(id)});
}

function clickNode(id) {
	if(isCollapsable(id))
	{
		appliedSCC.push(getsccID(id));
		collapseSCC(render);
	}
	else if (appliedSCC.includes(id))
	{
		appliedSCC.splice(appliedSCC.indexOf(id),1);
		collapseSCC(render);
	}
	console.log(id);
}

function render_graph(render) {
      
      nodes.forEach(function(node) {
          g.setNode(node["id"], { label: node["label"] }); 
      });
      links.forEach((edge)=>{
         g.setEdge.apply(g, edge);
      })   
      g.graph().rankdir = "TB";
      g.graph().nodesep = 60;  
      g.graph().transition = function(selection) {
      	return selection.transition().duration(500);
      };

      g.nodes().forEach(function(v) {
        var node = g.node(v);
        // Round the corners of the nodes
        node.rx = node.ry = 5;
      });

      render(inner, g);  
  
  // Center the graph
  var initialScale = 0.75;
  zoom
    .translate([(svg.attr("width") - g.graph().width * initialScale) / 2, 20])
    .scale(initialScale)
    .event(svg);
  svg.attr('height', g.graph().height * initialScale + 40);  
  
  svg.selectAll("g.node").on("click", function(id){clickNode(id)});

}

// Set up zoom support
var zoom = d3.behavior.zoom().on("zoom", function() {
      inner.attr("transform", "translate(" + d3.event.translate + ")" +
                                  "scale(" + d3.event.scale + ")");
    });
svg.call(zoom);


// Create the renderer
var render = new dagreD3.render();

render_graph(render);

// Run the renderer. This is what draws the final graph.


</script>
</body>
</html>
